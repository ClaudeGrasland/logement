---
title: "Analyse spatiale et territoriale de données de recensement"
author: "C.GRASLAND"
date: "15/10/2020"
output:
  beamer_presentation:
    colortheme: beaver
    fonttheme: structurebold
    theme: Madrid
  slidy_presentation: default
subtitle: Formation Carthageo-Geoprisme 2020 / 2e journée
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(xtable)
library(survey)
library(knitr)
library(dplyr)
library(tidyr)
library(questionr)
library(sf)
library(cartography)
```



# 2. CARTOGRAPHIE : L'EXEMPLE DU TAUX DE DEPENDANCE AUTOMOBILE A TOULOUSE

## Charger les données statistiques

On importe le fichier des individus localisés dans la métropole de Toulouse

### programme
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=T}
tab_ind<-readRDS("data/Toulouse/don_logt_2016.rda")
```

### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
head(tab_ind[,1:5],3)
```


## Charger les données géométriques

On importe le fichier des iris de Toulouse en ne gardant que les colonnes utiles et en les recodant.

### programme
```{r,comment=F,message=F, error=FALSE, comments = F, echo=T}
map_iris <- readRDS("data/Toulouse/map_iris.rda")
map_iris<-map_iris[,c(4,5,1,2,7)]
names(map_iris)<-c("IRIS","NOM_IRIS","COM","NOM_COM","geometry")
```

### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
knitr::kable(head(as.data.frame(map_iris)[,1:4],2))
```


## Visualisation du fonds iris

On peut facilement produire une carte vierge des iris du Grand Paris en faisant un plot de la colonne *geometry* du fichier sf

### programme
```{r,comment=F,message=F, error=FALSE, comments = F, echo=T}
plot(map_iris$geometry,col="lightyellow")
```


## Fusion des données statistiques et géométriques

Grâce aux nouveaux packages de R (*dplyr* et *sf*) il est possible d'**agréger simultanément les statistiques et les géométries** après les avoir stockés dans un même objet de type "sf"

Du coup, on peut gagner beaucoup de temps dans les traitetements et les analyses cartographiques, en particulier si l'on veut tester différents niveaux d'agrégation.


##  Agrégation des données individuelles par iris (1/2)


### programme
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=T}
tab<- tab_ind %>%
      filter(VOIT !="X")%>%
      group_by(IRIS,VOIT)%>%
      summarise(NB=sum(IPONDL))%>%
      spread(key=VOIT, value=NB, fill=0) 
names(tab)<-c("IRIS","VOIT0","VOIT1","VOIT2","VOIT3")
tab$VOIT<-tab$VOIT1+2*tab$VOIT2+3*tab$VOIT3
tab$POP<-tab$VOIT0+tab$VOIT1+tab$VOIT2+tab$VOIT3
tab$VOIT_POP <-tab$VOIT/tab$POP
tab<-tab[,c(1,6,7,8)]
```

##  Agrégation des données individuelles par communes (2/2)

### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
knitr::kable(head(tab,8),digits=2)
```


## Jointure des données communales (stock) et du fonds de carte

### programme 
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=T,warning=F}
map_iris_tab<-merge(map_iris,tab,
                   by.x="IRIS",by.y="IRIS",
                   all.x=T,all.y=F)
st_write(map_iris_tab,"data/Toulouse/map_iris_tab.shp",
         quiet = T, delete_dsn = T)
```

N.B. Enlever l'instruction *delete_dsn=T* si le fonds de carte n'existe pas encore.


### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
knitr::kable(head(as.data.frame(map_iris_tab)[,1:6],3),digits=2)
```

## Agrégation des iris en commune

L'agrégation est très facile et elle concerne à la fois les variables (de stock) et les geometries

### programme
```{r,comment=F,message=F, error=FALSE,echo=T,warning=F}
map_com_tab <- map_iris_tab %>% 
  group_by(COM) %>% 
  summarise(NOM_COM=min(NOM_COM), 
            VOIT=sum(VOIT,na.rm=T), POP=sum(POP,na.rm=T)) %>%
  mutate (VOIT_POP = VOIT/POP) %>%
  st_cast("MULTIPOLYGON")

st_write(map_com_tab,"data/Toulouse/map_com_tab.shp",
         quiet = T, delete_dsn = T)
```




## Agrégation des iris en communes

### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
plot(map_com_tab$geometry,col ="lightyellow")
```


## Agrégation des communes en Centre-Périphérie

On veut construire une carte opposant la commune centre et le reste de la métropole.

### programme
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE, warning=F,echo=T}
map_com_tab$CP <- "Périphérie"
map_com_tab$CP[map_com_tab$NOM_COM=="Toulouse"] <-"Centre"
map_cp_tab <- map_com_tab %>% 
  group_by(CP) %>% 
  summarise(VOIT=sum(VOIT,na.rm=T), 
            POP=sum(POP,na.rm=T)) %>%
  mutate (VOIT_POP = VOIT/POP) %>%
  st_cast("MULTIPOLYGON")

st_write(map_cp_tab,"data/Toulouse/map_cp_tab.shp",
         quiet = T, delete_dsn = T)
```

N.B. Enlever l'instruction *delete_dsn=T* si le fonds de carte n'existe pas encore.


## Agrégation des communes en EPT

### résultat
```{r, cache.comments=TRUE,comment=F,message=F, error=FALSE,echo=F}
plot(map_cp_tab$geometry,col ="lightyellow")
```




## Cartographie par iris de Toulouse 

On va utiliser le package *cartography* mis au point par les ingénieurs de l'UMS 2414 RIATE. Les différents morceaux de programme ci-dessous sont à executer simultanément. 

### Programme (1/3) : trace les fonds de carte iris et com


map<-map_iris_tab  

map2<-map_com_tab  

par(mar=c(0,0,2,0))  

plot(map2\$geometry,lwd=1,col=c("gray70"),border="white")   

plot(map\$geometry, lwd=0.3,add=T,border="white",col=NA)






## Cartographie par iris de la métropole de Toulouse

### Programme (2/3) : trace la carte (POP & VOIT_POP)


propSymbolsChoroLayer(map,   
                      var = "POP",   
                      inches = 0.10,   
                      var2 = "VOIT_POP",   
                      breaks = c(0,0.3,0.5,0.7,1,1.3,1.6,1.9,2.5),   
                      nclass = 8,   
                      col = carto.pal(pal1="green.pal", n1=4, pal2 = "orange.pal", n2 = 4),   
                      border = "grey40",   
                      lwd=0.2,   
                      legend.var.pos="topright",   
                      legend.var.values.rnd = 0,   
                      legend.var.title.txt = "Population",    
                      legend.var.style = "e",   
                      legend.var2.pos = "topleft",   
                      legend.var2.title.txt = "Auto./ habitant",   
                      legend.var2.values.rnd = 1)    
  

## Cartographie par iris de la métropole de Toulouse

### Programme (3/3) : ajoute l'habillage de la carte

layoutLayer(title = "Dépendance automobile à Toulouse en 2016",   
            author = "(c) Claude GRASLAND, UMR Géographie-cités, 2020",   
            col = "grey",   
            scale=4,   
            source="INSEE - RP 2016")   
   



## Cartographie par iris de la métropole de Toulouse

```{r, cache.comments=TRUE,comment="",message=F, error=FALSE,echo=F, warning=F}
map<-map_iris_tab
map2<-map_com_tab

par(mar=c(0,0,2,0))
plot(map2$geometry,lwd=1,col=c("gray70"),border="white")
plot(map$geometry, lwd=0.3,add=T,border="white",col=NA)


propSymbolsChoroLayer(map,
                      var = "POP",
                      inches = 0.10,
                      var2 = "VOIT_POP",
                      breaks = c(0,0.3,0.5,0.7,1,1.3,1.6, 1.9,2.5),
                      nclass = 8,
                      col = carto.pal(pal1="green.pal", n1=4, pal2 = "orange.pal", n2 = 4),
                      border = "grey40",
                      lwd=0.2,
                      legend.var.pos="topright",
                      legend.var.values.rnd = 0,
                      legend.var.title.txt = "Population", 
                      legend.var.style = "e",
                      legend.var2.pos = "topleft",
                      legend.var2.title.txt = "Auto./ habitant",
                      legend.var2.values.rnd = 1)


layoutLayer(title = "Dépendance automobile dans la métropole de Toulouse en 2016 - par iris",
            author = "(c) Claude GRASLAND, UMR Géographie-cités, 2020",
            col = "grey",
            scale=4,
            source="INSEE - RP 2020")

```

## Cartographie par iris de la commune de Toulouse

```{r, cache.comments=TRUE,comment="",message=F, error=FALSE,echo=F, warning=F}
map<-map_iris_tab[map_iris_tab$NOM_COM=="Toulouse",]
map2<-map_com_tab[map_com_tab$NOM_COM=="Toulouse",]

par(mar=c(0,0,2,0))
plot(map2$geometry,lwd=1,col=c("gray70"),border="white")
plot(map$geometry, lwd=0.3,add=T,border="white",col=NA)


propSymbolsChoroLayer(map,
                      var = "POP",
                      inches = 0.10,
                      var2 = "VOIT_POP",
                      breaks = c(0,0.3,0.5,0.7,1,1.3,1.6, 1.9,2.5),
                      nclass = 8,
                      col = carto.pal(pal1="green.pal", n1=4, pal2 = "orange.pal", n2 = 4),
                      border = "grey40",
                      lwd=0.2,
                      legend.var.pos="topright",
                      legend.var.values.rnd = 0,
                      legend.var.title.txt = "Population", 
                      legend.var.style = "e",
                      legend.var2.pos = "topleft",
                      legend.var2.title.txt = "Auto./ habitant",
                      legend.var2.values.rnd = 1)


layoutLayer(title = "Dépendance automobile dans la commune de Toulouse - par iris",
            author = "(c) Claude GRASLAND, UMR Géographie-cités, 2020",
            col = "grey",
            scale=4,
            source="INSEE - RP 2016")


```



## Cartographie par communes due la métropole de Toulouse

```{r, cache.comments=TRUE,comment="",message=F, error=FALSE,echo=F, warning=F}
map<-map_com_tab
map2<-map_cp_tab

par(mar=c(0,0,2,0))
plot(map2$geometry,lwd=1,col=c("gray70"),border="white")
plot(map$geometry, lwd=0.3,add=T,border="white",col=NA)


propSymbolsChoroLayer(map,
                      var = "POP",
                      inches = 0.6,
                      var2 = "VOIT_POP",
                      breaks = c(0,0.3,0.5,0.7,1,1.3,1.6, 1.9,2.5),
                      nclass = 8,
                      col = carto.pal(pal1="green.pal", n1=4, pal2 = "orange.pal", n2 = 4),
                      border = "grey40",
                      lwd=0.2,
                      legend.var.pos="topright",
                      legend.var.values.rnd = 0,
                      legend.var.title.txt = "Population", 
                      legend.var.style = "e",
                      legend.var2.pos = "topleft",
                      legend.var2.title.txt = "Auto./ habitant",
                      legend.var2.values.rnd = 1)


layoutLayer(title = "Dépendance automobile dans la métropole de Toulouse en 2016 - par communes",
            author = "(c) Claude GRASLAND, UMR Géographie-cités, 2020",
            col = "grey",
            scale=4,
            source="INSEE - RP 2016")


```

## Cartographie Centre Périphérie 

```{r, cache.comments=TRUE,comment="",message=F, error=FALSE,echo=F, warning=F}
map<-map_cp_tab
map2<-map_cp_tab
par(mar=c(0,0,2,0))
plot(map2$geometry,lwd=1,col=c("gray70"),border="white")
plot(map$geometry, lwd=0.3,add=T,border="white",col=NA)


propSymbolsChoroLayer(map,
                      var = "POP",
                      inches = 0.6,
                      var2 = "VOIT_POP",
                      breaks = c(0,0.3,0.5,0.7,1,1.3,1.6, 1.9,2.5),
                      nclass = 8,
                      col = carto.pal(pal1="green.pal", n1=4, pal2 = "orange.pal", n2 = 4),
                      border = "grey40",
                      lwd=0.5,
                      legend.var.pos="topright",
                      legend.var.values.rnd = 0,
                      legend.var.title.txt = "Population", 
                      legend.var.style = "e",
                      legend.var2.pos = "topleft",
                      legend.var2.title.txt = "Auto./ habitant",
                      legend.var2.values.rnd = 1)


layoutLayer(title = "Dépendance automobile dans le centre et la périphérie de Toulouse en 2016",
            author = "(c) Claude GRASLAND, UMR Géographie-cités, 2020",
            col = "grey",
            scale=4,
            source="INSEE - RP 2016")

```


## Conclusion

### Au niveau Centre-Périphérie
Dépendance automobile beaucoup plus forte de la périphérie. Population plus grande dans le centre que dans la périphérie.

### Au niveau des communes
Organisation générale en gradient. Hausse de la dépendance en fonction de la distance au centre et (sans doute) de la présence de lignes de transport en commun. 

### Au niveau des iris
Existence de variatons parfois importantes dans une même commune, notamment à l'intérieur de la commune de Toulouse